<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bit.domain.novel">
	<!-- 등록 -->
	<insert id="create">
		insert all
		into novel(title,n_description,image,ending) 
		values(#{novle.title},#{novle.n_description},#{novle.image},#{novle.ending})
	</insert>

	<!-- 열람 -->
	<select id="read" resultMap="Novel_allResultMap">
		SELECT * FROM novel WHERE n_id =
		#{novel.n_id}
	</select>

	<!-- 수정 -->
	<update id="update">
		UPDATE novel SET title = #{novel.title},
		n_description =
		#{novel.n_description}, image = #{novel.image}, ending
		= #{novel.ending}
		where n_id =
		#{novel.n_id}
	</update>

	<!-- 삭제 -->
	<delete id="delete">
		DELETE FROM novel WHERE n_id = #{novel.novel.n_id}
	</delete>
	<!-- 목록 -->
	<select id="listAll" resultMap="Novel_allResultMap">
		<![CDATA[
		SELECT n_id, title, n_description, image, ending FROM novel where n_id > 0
		ORDER BY n_id DESC
		]]>
	</select>
	<!-- 페이징 -->
	<select id="listPaging" resultMap="Novel_allResultMap">
		<![CDATA[
		SELECT n_id, title, n_description, image, ending FROM novel where n_id > 0
		ORDER BY n_id DESC
		LIMIT #{page}, 10
		]]>
	</select>
	<select id="listCriteria" resultMap="Novel_allResultMap">
			<![CDATA[
		SELECT n_id, title, n_description, image, ending FROM novel where n_id > 0
		]]>
		<include refid="search" />
		<![CDATA[ORDER BY n_id DESC
		LIMIT #{pageStart}, #{perPageNum}]]>
	</select>
	<!-- 전체 작가 수 -->
	<select id="countNovels" resultType="int">
			<![CDATA[
		SELECT COUNT(n_id)
		FROM novel
		where n_id > 0
		]]>
		<include refid="search" />
	</select>
	<!--동적 sql -->
	<sql id="add">
		<if test="author.a_name != null">
			INTO novel_author(n_id, a_id) SELECT LAST_INSERT_ID(), a.a_id FROM author a, NOVEL n
			WHERE a.a_id = #{author.a_name})
		</if>
		<if test="p_id != null">
			INTO novel_pub(n_id, p_id)
			VALUES(#{novel_pub.n_id},#{novel_pub.p_id})
		</if>
		<if test="w_id != null">
			INTO novel_web(n_id, w_id)
			VALUES(#{novel_web.n_id},#{novel_web.w_id})
		</if>

	</sql>
	<sql id="search">
		<if test="keyword != null">
			AND title like concat('%', #{keyword}, '%')
		</if>
	</sql>
	<!--동적 sql -->


	<!-- 매핑 -->
	<resultMap id="NovelResultMap" type="com.bit.domain.NovelVO">
		<id property="n_id" column="n_id" />
		<result property="title" column="title" />
		<result property="n_description" column="n_description" />
		<result property="image" column="image" />
		<result property="ending" column="ending" />
	</resultMap>
	<resultMap id="Novel_authorResultMap"
		type="com.bit.domain.Novel_authorVO">
		<id property="n_id" column="n_id" />
		<id property="a_id" column="a_id" />
	</resultMap>
	<resultMap id="Novel_charResultMap"
		type="com.bit.domain.Novel_charVO">
		<id property="n_id" column="n_id" />
		<id property="c_id" column="c_id" />
	</resultMap>
	<resultMap id="Novel_ntagResultMap"
		type="com.bit.domain.Novel_ntagVO">
		<id property="n_id" column="n_id" />
		<id property="nt_id" column="nt_id" />
	</resultMap>
	<resultMap id="Novel_pubResultMap"
		type="com.bit.domain.Novel_pubVO">
		<id property="n_id" column="n_id" />
		<id property="p_id" column="p_id" />
	</resultMap>
	<resultMap id="Novel_webResultMap"
		type="com.bit.domain.Novel_webVO">
		<id property="n_id" column="n_id" />
		<id property="w_id" column="w_id" />
	</resultMap>
	<resultMap id="Novel_userResultMap"
		type="com.bit.domain.Novel_userVO">
		<id property="n_id" column="n_id" />
		<id property="u_id" column="u_id" />
		<result property="label" column="label" />
		<result property="vote" column="vote" />
	</resultMap>
	<resultMap id="AuthorResultMap"
		type="com.bit.domain.AuthorVO">
		<id property="a_id" column="a_id" />
		<result property="a_name" column="a_name" />
		<result property="gender" column="gender" />
		<result property="a_history" column="a_history" />
	</resultMap>
	<resultMap id="WebResultMap" type="com.bit.domain.WebVO">
		<id property="w_id" column="w_id" />
		<result property="w_name" column="w_name" />
		<result property="url" column="url" />
	</resultMap>
	<resultMap id="PubResultMap"
		type="com.bit.domain.PublisherVO">
		<id property="p_id" column="p_id" />
		<result property="p_name" column="p_name" />
		<result property="url" column="url" />
	</resultMap>
	<resultMap id="Novel_allResultMap"
		type="com.bit.domain.Novel_allVO">
		<collection property="novel" resultMap="NovelResultMap" />
		<collection property="novel_author"
			resultMap="Novel_authorResultMap" />
		<collection property="novel_char"
			resultMap="Novel_charResultMap" />
		<collection property="novel_ntag"
			resultMap="Novel_ntagResultMap" />
		<collection property="novel_pub"
			resultMap="Novel_pubResultMap" />
		<collection property="novel_web"
			resultMap="Novel_webResultMap" />
		<collection property="novel_user"
			resultMap="Novel_userResultMap" />
		<collection property="author" resultMap="AuthorResultMap" />
		<collection property="web" resultMap="WebResultMap" />
		<collection property="pub" resultMap="PubResultMap" />
	</resultMap>
	<!-- 매핑 -->

</mapper>

